# CLAUDE.md - Global Events Heatmap

## Project Overview

A 3D interactive globe website that visualizes real-time global news events as a heatmap, with a secondary "predictions" mode powered by Polymarket data. The goal is to create a compelling, useful news consumption experience for people who want to stay informed about global events at a glance.

## Tech Stack

- **Frontend**: React 18 + TypeScript + Vite
- **3D Rendering**: Three.js with custom GLSL shaders
- **Backend**: Node.js + Express + TypeScript
- **Database**: PostgreSQL with PostGIS extension for geospatial queries
- **Cache**: Redis (15-min TTL for aggregated data)
- **Real-time**: WebSockets (Socket.io) with SSE fallback
- **Deployment**: Docker Compose

## Project Structure

```
globe-news/
├── client/                    # React frontend
│   ├── src/
│   │   ├── components/
│   │   │   ├── Globe/        # Three.js globe renderer
│   │   │   ├── Heatmap/      # Shader-based heatmap layer
│   │   │   ├── EventPanel/   # Side panel for event details
│   │   │   ├── Controls/     # UI controls (filters, time range)
│   │   │   └── Predictions/  # Polymarket visualization
│   │   ├── hooks/            # Custom React hooks
│   │   ├── services/         # API client, WebSocket handler
│   │   ├── stores/           # Zustand state management
│   │   ├── shaders/          # GLSL shader files
│   │   └── types/            # TypeScript interfaces
│   └── public/
│       └── textures/         # Earth textures, normal maps
├── server/                    # Express backend
│   ├── src/
│   │   ├── routes/           # API endpoints
│   │   ├── services/
│   │   │   ├── aggregator/   # News source aggregation
│   │   │   ├── geocoder/     # Location extraction & geocoding
│   │   │   ├── polymarket/   # Prediction market integration
│   │   │   └── dedup/        # Event deduplication
│   │   ├── workers/          # Background polling jobs
│   │   ├── db/               # Database models & migrations
│   │   └── types/
│   └── scripts/              # Utility scripts
├── docker-compose.yml
└── CLAUDE.md
```

## Core Data Schemas

### Event (News)
```typescript
interface Event {
  id: string;
  title: string;
  summary: string;
  lat: number;
  lng: number;
  timestamp: Date;
  source: string;
  sourceUrl: string;
  category: 'conflict' | 'politics' | 'disaster' | 'economics' | 'health' | 'technology' | 'environment';
  intensity: number;        // 0-100, calculated from source count + sentiment + recency
  imageUrl?: string;
  entities: string[];       // Extracted people, organizations, places
  gdeltTone?: number;       // GDELT sentiment score if available
  relatedEventIds: string[];
}
```

### Prediction (Polymarket)
```typescript
interface Prediction {
  marketId: string;
  question: string;
  probability: number;      // 0-1
  volume: number;           // USD trading volume
  endDate: Date;
  locations: {              // Can map to multiple locations
    lat: number;
    lng: number;
    confidence: number;     // How confident we are this market relates to this location
  }[];
  category: 'election' | 'geopolitical' | 'disaster' | 'economic' | 'other';
  url: string;
}
```

### HeatmapPoint
```typescript
interface HeatmapPoint {
  lat: number;
  lng: number;
  intensity: number;        // Aggregated from events in this hex cell
  eventCount: number;
  dominantCategory: string;
  h3Index: string;          // H3 hexagonal grid cell ID
}
```

## Data Sources

### News APIs (in priority order)
1. **GDELT Project** (PRIMARY) - Free, real-time, includes lat/long
   - Endpoint: `https://api.gdeltproject.org/api/v2/doc/doc`
   - Rate limit: Generous, but be respectful
   - Returns: Events with tone scores, locations, themes
   
2. **NewsAPI.org** - Good headlines, needs geocoding
   - Free tier: 100 requests/day
   - Use for supplementary headlines
   
3. **EventRegistry.org** - Good deduplication
   - Free tier: 2000 tokens/month
   - Use for entity extraction
   
4. **RSS Feeds** (fallback) - Reuters, AP, BBC World
   - Parse with `rss-parser`
   - Geocode locations from text

### Prediction Markets
- **Polymarket API**: `https://docs.polymarket.com/`
  - Public endpoints for active markets
  - Need to extract geographic relevance from question text

### Geocoding
- **OpenStreetMap Nominatim** - Free, rate limited (1 req/sec)
- Cache all geocoding results aggressively

## Key Implementation Details

### Globe Rendering
- Use `three-globe` as base, customize heavily
- Earth texture: NASA Blue Marble (8k for desktop, 4k for mobile)
- Atmosphere shader for glow effect
- Day/night terminator based on real UTC time
- OrbitControls with damping for smooth feel

### Heatmap Shader
Do NOT use DOM-based heatmaps - too slow. Instead:
- Custom fragment shader that samples from a data texture
- Data texture: 360x180 pixel intensity map (1 degree resolution)
- Update texture when data changes, not every frame
- Color ramp as uniform array
- Additive blending with globe texture

### Event Clustering
- Use H3 hexagonal grid (resolution 3-4 for global view)
- Aggregate events into hex cells
- When zoomed in, increase H3 resolution dynamically
- Cluster markers use logarithmic scaling for count display

### Deduplication
Events from different sources about the same story need merging:
- Fuzzy match titles using `fuzzball` (threshold: 0.7)
- Same-day events within 50km radius are candidates
- Merge: keep highest quality source, combine all source URLs
- Track canonical event ID for updates

### Intensity Scoring Algorithm
```
intensity = (
  sourceCount * 20 +           // More sources = bigger story
  abs(gdeltTone) * 10 +        // Strong sentiment = more significant
  recencyBonus +               // Decay over 24h
  categoryMultiplier           // Conflicts weighted higher than tech news
) / maxIntensity * 100
```

### Polymarket Geographic Extraction
1. Run market question through NER (use compromise.js or similar)
2. Extract location entities
3. Check against known patterns:
   - "US Presidential" → USA
   - "UK General Election" → UK
   - "Israel-Iran" → Both countries
4. Assign confidence based on extraction method
5. Fall back to manual mapping table for common markets

## API Endpoints

```
GET  /api/events
     ?bounds=lat1,lng1,lat2,lng2    # Viewport bounding box
     &since=ISO8601                  # Events after this time
     &categories=conflict,politics   # Filter by category
     &limit=100
     
GET  /api/events/:id                 # Single event with full details

GET  /api/heatmap
     ?resolution=low|medium|high     # H3 resolution
     &timeRange=1h|6h|24h|7d
     &categories=...
     
GET  /api/predictions
     ?bounds=...
     &minProbability=0.1
     &minVolume=10000
     
GET  /api/predictions/:marketId

WS   /ws/events                      # Real-time event stream
```

## Build & Run Commands

```bash
# Development
cd client && npm run dev           # Vite dev server on :5173
cd server && npm run dev           # Express with nodemon on :3001

# Database
docker-compose up -d postgres redis
npm run db:migrate
npm run db:seed                    # Load sample data for testing

# Production build
npm run build                      # Builds both client and server
docker-compose up -d               # Full stack

# Testing
npm run test                       # Jest tests
npm run test:e2e                   # Playwright for globe interactions
```

## Environment Variables

```env
# Server
DATABASE_URL=postgresql://user:pass@localhost:5432/globenews
REDIS_URL=redis://localhost:6379
GDELT_RATE_LIMIT=10                # Requests per minute
NEWSAPI_KEY=your_key
EVENTREGISTRY_KEY=your_key

# Client
VITE_API_URL=http://localhost:3001
VITE_WS_URL=ws://localhost:3001
```

## Development Phases

### Phase 1: Globe Foundation
- [ ] Three.js globe with earth texture rendering
- [ ] OrbitControls with smooth damping
- [ ] Click detection with lat/lng conversion
- [ ] Basic UI shell (header, side panel placeholder)

### Phase 2: Data Pipeline
- [ ] GDELT integration with polling worker
- [ ] PostgreSQL + PostGIS setup
- [ ] Event deduplication service
- [ ] REST API for events

### Phase 3: Heatmap Visualization
- [ ] Custom heatmap shader
- [ ] H3 hexagonal binning
- [ ] Time range filtering
- [ ] Category filtering

### Phase 4: Event Interaction
- [ ] Click-to-select events
- [ ] Event detail panel
- [ ] Cluster expansion
- [ ] Related events

### Phase 5: Predictions Mode
- [ ] Polymarket API integration
- [ ] Geographic extraction from market questions
- [ ] Prediction markers on globe
- [ ] Toggle between news/predictions modes

### Phase 6: Polish & Deploy
- [ ] WebSocket real-time updates
- [ ] Performance optimization
- [ ] Mobile responsive
- [ ] Docker production setup

## Performance Targets

- Initial load: < 3 seconds on 4G
- Globe interaction: 60fps on mid-range hardware
- Data refresh: Every 5 minutes background, instant on WebSocket
- Heatmap update: < 100ms after data change

## Design Notes

- Dark theme default (globe looks better)
- Glassmorphism cards for overlays
- Color palette: 
  - News heatmap: Blue → Yellow → Orange → Red
  - Predictions: Purple → Teal gradient
- Minimal UI - let the globe be the hero
- Animations should feel physical (easing, momentum)

## Known Gotchas

1. **CORS**: GDELT doesn't set CORS headers - proxy through backend
2. **Globe texture seams**: Use seamless textures, check UV mapping
3. **Mobile touch**: Three.js touch events need explicit handling
4. **Memory leaks**: Dispose Three.js geometries/materials on unmount
5. **Timezone hell**: Store everything UTC, convert for display only
6. **Polymarket rate limits**: Cache aggressively, they're not super generous

## Resources

- [Three.js Globe Examples](https://github.com/vasturiano/three-globe)
- [GDELT Documentation](https://blog.gdeltproject.org/gdelt-doc-2-0-api-debuts/)
- [H3 Hexagonal Grid](https://h3geo.org/)
- [Polymarket API Docs](https://docs.polymarket.com/)
- [NASA Blue Marble](https://visibleearth.nasa.gov/collection/1484/blue-marble)
